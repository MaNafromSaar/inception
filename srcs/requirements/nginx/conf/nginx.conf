# Main Nginx configuration file

user www-data; # User Nginx will run as
worker_processes auto; # Auto-detect number of worker processes
pid /run/nginx.pid; # PID file location

# Include files in /etc/nginx/modules-enabled/*.conf (if any)
# include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 768; # Max connections per worker
    # multi_accept on; # Accept multiple connections at once
}

http {
    # Basic Settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    # server_tokens off; # Hide Nginx version

    # Mime types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging Settings
    # access_log /var/log/nginx/access.log;
    # error_log /var/log/nginx/error.log;
    # For Docker, it\'s better to log to stdout/stderr
    access_log /dev/stdout;
    error_log /dev/stderr warn;


    # Gzip Settings (Optional)
    # gzip on;
    # gzip_disable "msie6";
    # gzip_vary on;
    # gzip_proxied any;
    # gzip_comp_level 6;
    # gzip_buffers 16 8k;
    # gzip_http_version 1.1;
    # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Virtual Host Configs
    # include /etc/nginx/conf.d/*.conf; # Default include for site configs
    # include /etc/nginx/sites-enabled/*; # Another common include pattern

    # Server block for your WordPress site
    server {
        listen 443 ssl http2; # Listen on port 443 for HTTPS, enable HTTP/2
        listen [::]:443 ssl http2; # IPv6

        # Domain name from environment variable (will be substituted by entrypoint script)
        # server_name ${DOMAIN_NAME}; # This needs envsubst to work
        # For now, hardcode or ensure your entrypoint handles this.
        # The subject uses yourlogin.42.fr. Let\'s assume DOMAIN_NAME is correctly set.
        server_name yourlogin.42.fr; # Placeholder, will be replaced by entrypoint or use actual value

        # SSL Configuration
        # Paths to SSL certificate and key (inside the container)
        ssl_certificate /etc/nginx/ssl/yourlogin.42.fr.crt;
        ssl_certificate_key /etc/nginx/ssl/yourlogin.42.fr.key;

        # Enforce strong SSL/TLS protocols and ciphers
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        # Example strong ciphers (consult current best practices)
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off; # Consider security implications
        # ssl_stapling on; # Optional: OCSP Stapling
        # ssl_stapling_verify on; # Optional
        # resolver 8.8.8.8 8.8.4.4 valid=300s; # If using stapling, specify DNS resolver
        # resolver_timeout 5s;

        # Add HSTS header (Optional but recommended)
        # add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";

        # Root directory for WordPress files (Nginx might need this for some rules, or if serving static files directly)
        root /var/www/html;
        index index.php index.html index.htm;

        location / {
            try_files $uri $uri/ /index.php?$args;
        }

        # Pass PHP scripts to FastCGI server (WordPress - php-fpm)
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            # The `wordpress` service name from docker-compose.yml, port 9000 (php-fpm)
            fastcgi_pass wordpress:9000;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            # Add other necessary fastcgi params if needed
            fastcgi_param HTTP_PROXY ""; # Clear proxy header if Nginx is behind another proxy
            fastcgi_param HTTPS on; # Inform WordPress that connection is HTTPS
            fastcgi_read_timeout 300; # Increase timeout if needed
        }

        # Deny access to .htaccess and other hidden files
        location ~ /\.ht {
            deny all;
        }

        # Deny access to sensitive WordPress files
        location ~* /(?:uploads|files)/.*\.php$ {
            deny all;
        }
        location ~* ^/wp-config\.php {
            deny all;
        }
        location ~* ^/wp-admin/includes/ {
            deny all;
        }
        location ~* \.(engine|inc|info|install|make|module|profile|test|po|sh|sql|theme|tpl(\.php)?|xtmpl)$|^(\..*|Entries.*|Repository|Root|Tag|Template)$|\.php_ {
            deny all;
        }

        # Handle static files directly (optional, WordPress can also handle this)
        # location ~* \.(css|js|gif|jpg|jpeg|png|ico|woff|woff2|ttf|svg|eot)$ {
        #     expires 1M;
        #     access_log off;
        #     add_header Cache-Control "public";
        # }
    }

    # You can add other server blocks here for other sites or services (e.g., for bonus part)
}
